#
# Ronin Exploits - A Ruby library for Ronin that provides exploitation and
# payload crafting functionality.
#
# Copyright (c) 2007-2011 Hal Brodigan (postmodern.mod3 at gmail.com)
#
# This file is part of Ronin Exploits.
#
# Ronin is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Ronin is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Ronin.  If not, see <http://www.gnu.org/licenses/>
#

require 'ronin/post_exploitation/resource'

require 'set'

module Ronin
  module PostExploitation
    module Resources
      #
      # Leverages the Process resource.
      #
      # @since 1.0.0
      #
      class Process < Resource

        METHODS = Set[
          :process_getpid,
          :process_getppid,
          :process_getuid,
          :process_setuid,
          :process_geteuid,
          :process_seteuid,
          :process_getgid,
          :process_setgid,
          :process_getegid,
          :process_setegid,
          :process_getsid,
          :process_setsid,
          :process_getenv,
          :process_setenv,
          :process_unsetenv,
          :process_kill,
          :process_getcwd,
          :process_chdir,
          :process_time,
          :process_spawn,
          :process_exit
        ]

        #
        # Determines whether an object is compatible with {Process}.
        #
        # @param [Object] object
        #   The object in question.
        #
        # @return [Boolean]
        #   Specifies whether the object is compatible with {Process}.
        #
        def self.compatible?(object)
          METHODS.any? { |name| object.respond_to?(name) }
        end

        #
        # Gets the pid of the current process.
        #
        # @return [Integer]
        #   The current PID.
        #
        # @note
        #   Requires the `process_getpid` method be defined by the leveraging
        #   object.
        #
        def pid
          @controller.process_getpid
        end
        resource_method :pid, [:process_getpid]

        #
        # Gets the pid of the parent process.
        #
        # @return [Integer]
        #   The parent PID.
        #
        # @note
        #   Requires the `process_getppid` method be defined by the leveraging
        #   object.
        #
        def ppid
          @controller.process_getppid
        end
        resource_method :ppid, [:process_getppid]

        #
        # Gets the UID that the current process is running under.
        #
        # @return [Integer]
        #   The current UID.
        #
        # @note
        #   Requires the `process_getuid` method be defined by the leveraging
        #   object.
        #
        def uid
          @controller.process_getuid
        end
        resource_method :uid, [:process_getuid]

        #
        # Attempts to set the UID of the current process.
        #
        # @param [Integer] new_uid
        #   The new UID.
        #
        # @note
        #   Requires the `process_setuid` method be defined by the leveraging
        #   object.
        #
        def uid=(new_uid)
          @controller.process_setuid(new_uid)
        end
        resource_method :uid=, [:process_setuid]

        #
        # Gets the effective UID that the current process is running under.
        #
        # @return [Integer]
        #   The effective UID.
        #
        # @note
        #   Requires the `process_geteuid` method be defined by the leveraging
        #   object.
        #
        def euid
          @controller.process_geteuid
        end
        resource_method :euid, [:process_geteuid]

        #
        # Attempts to set the effective UID of the current process.
        #
        # @param [Integer] new_euid
        #   The new effective UID.
        #
        # @note
        #   Requires the `process_seteuid` method be defined by the leveraging
        #   object.
        #
        def euid=(new_euid)
          @controller.process_seteuid(new_euid)
        end
        resource_method :euid=, [:process_seteuid]

        #
        # Gets the GID that the current process is running under.
        #
        # @return [Integer]
        #   The current GID.
        #
        # @note
        #   Requires the `process_getgid` method be defined by the leveraging
        #   object.
        #
        def gid
          @controller.process_getgid
        end
        resource_method :gid, [:process_getgid]

        #
        # Attempts to set the GID of the current process.
        #
        # @param [Integer] new_gid
        #   The new GID.
        #
        # @note
        #   Requires the `process_setgid` method be defined by the leveraging
        #   object.
        #
        def gid=(gid)
          @controller.process_setgid(new_gid)
        end
        resource_method :gid=, [:process_setgid]

        #
        # Gets the effective GID that the current process is running under.
        #
        # @return [Integer]
        #   The effective GID.
        #
        # @note
        #   Requires the `process_getegid` method be defined by the leveraging
        #   object.
        #
        def egid
          @controller.process_getegid
        end
        resource_method :egid, [:process_getegid]

        #
        # Attempts to set the effective GID of the current process.
        #
        # @param [Integer] new_egid
        #   The new effective GID.
        #
        # @note
        #   Requires the `process_setegid` method be defined by the leveraging
        #   object.
        #
        def egid=(new_egid)
          @controller.process_setegid(new_egid)
        end
        resource_method :egid=, [:process_setegid]

        #
        # Gets the SID of the current process.
        #
        # @return [Integer]
        #   The current SID.
        #
        # @note
        #   Requires the `process_getsid` method be defined by the leveraging
        #   object.
        #
        def sid
          @controller.process_getsid
        end
        resource_method :sid, [:process_getsid]

        #
        # Sets the SID of the current process.
        #
        # @note
        #   Requires the `process_setsid` method be defined by the leveraging
        #   object.
        #
        def setsid
          @controller.process_setsid
        end
        resource_method :setsid, [:process_setsid]

        #
        # Retrieves the value of a environment variable.
        #
        # @param [String] name
        #   The name of the environment variable.
        #
        # @return [String, nil]
        #   The value of the environment variable.
        #
        # @note
        #   Requires the `process_getenv` method be defined by the leveraging
        #   object.
        #
        # @api public
        #
        def getenv(name)
          @controller.process_getenv(name)
        end
        resource_method :getenv, [:process_getenv]

        #
        # Sets the value of a environment variable.
        #
        # @param [String] name
        #   The name of the environment variable.
        #
        # @param [String] value
        #   The new value for the environment variable.
        #
        # @note
        #   Requires the `process_setenv` method be defined by the leveraging
        #   object.
        #
        # @api public
        #
        def setenv(name,value)
          @controller.process_setenv(name,value)
        end
        resource_method :setenv, [:process_setenv]

        #
        # Unsets an environment variable.
        #
        # @param [String] name
        #   The name of the environment variable.
        #
        # @note
        #   Requires the `process_unsetenv` method be defined by the leveraging
        #   object.
        #
        # @api public
        #
        def unsetenv(name)
          @controller.process_unsetenv(name)
        end
        resource_method :unsetenv, [:process_unsetenv]

        #
        # Kills a process.
        #
        # @param [Integer] pid
        #   The PID of the process to kill.
        #
        # @param [String] signal
        #   The POSIX signal name to send to the process.
        #
        # @note
        #   Requires the `process_kill` method be defined by the leveraging
        #   object.
        #
        def kill(pid,signal='KILL')
          @controller.process_kill(pid,signal)
        end
        resource_method :kill, [:process_kill]

        #
        # Gets the working directory of the current process.
        #
        # @return [String]
        #   The current working directory.
        #
        # @note
        #   Requires the `process_getcwd` method be defined by the leveraging
        #   object.
        #
        def getcwd
          @controller.process_getcwd
        end
        resource_method :getcwd, [:process_getcwd]

        #
        # Changes the working directory of the current process.
        #
        # @param [String] path
        #   The new working directory.
        #
        # @return [String]
        #   The new current working directory.
        #
        # @note
        #   Requires the `process_chdir` method be defined by the leveraging
        #   object.
        #
        def chdir(path)
          @controller.process_chdir(path)
        end
        resource_method :chdir, [:process_chdir]

        #
        # Gets the current time.
        #
        # @return [Time]
        #   The current time.
        #
        # @note
        #   Requires the `process_time` method be defined by the leveraging
        #   object.
        #
        def time
          @controller.process_time
        end
        resource_method :time, [:process_time]

        #
        # Executes a program as a separate child process.
        #
        # @param [String] program
        #   The name or path of the program.
        #
        # @param [Array<String>] arguments
        #   Additional arguments to execute the program with.
        #
        # @return [Integer]
        #   The pid of the new process.
        #
        # @note
        #   Requires the `process_spawn` method be defined by the leveraging
        #   object.
        #
        # @api public
        #
        def spawn(program,*arguments)
          @controller.process_spawn(program,*arguments)
        end
        resource_method :spawn, [:process_spawn]

        #
        # Exits the current running process.
        #
        # @note
        #   Requires the `process_exit` method be defined by the leveraging
        #   object.
        #
        def exit
          @controller.process_exit
        end
        resource_method :exit, [:process_exit]

      end
    end
  end
end
